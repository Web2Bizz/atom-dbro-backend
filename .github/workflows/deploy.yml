name: Build and Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  NODE_VERSION: '20'

jobs:
  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    env:
      DOCKER_REGISTRY_INSECURE: ${{ secrets.DOCKER_REGISTRY_INSECURE }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Validate and sanitize environment variables
        id: validate
        run: |
          # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¸ Ð¾Ñ‡Ð¸Ñ‰Ð°ÐµÐ¼ DOCKER_REGISTRY_URL
          REGISTRY_URL="${DOCKER_REGISTRY_URL}"
          REGISTRY_URL=$(echo "$REGISTRY_URL" | sed 's|^https\?://||' | sed 's|/$||')
          
          # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¸ Ð¾Ñ‡Ð¸Ñ‰Ð°ÐµÐ¼ DOCKER_IMAGE_NAME
          IMAGE_NAME="${DOCKER_IMAGE_NAME}"
          # Ð£Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð²ÑÐµ ÑÐ¸Ð¼Ð²Ð¾Ð»Ñ‹, ÐºÑ€Ð¾Ð¼Ðµ ÑÑ‚Ñ€Ð¾Ñ‡Ð½Ñ‹Ñ… Ð±ÑƒÐºÐ², Ñ†Ð¸Ñ„Ñ€, Ð´ÐµÑ„Ð¸ÑÐ¾Ð², Ð¿Ð¾Ð´Ñ‡ÐµÑ€ÐºÐ¸Ð²Ð°Ð½Ð¸Ð¹ Ð¸ Ñ‚Ð¾Ñ‡ÐµÐº
          IMAGE_NAME=$(echo "$IMAGE_NAME" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9._-]//g')
          
          echo "registry_url=$REGISTRY_URL" >> $GITHUB_OUTPUT
          echo "image_name=$IMAGE_NAME" >> $GITHUB_OUTPUT
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ Ð½Ðµ Ð¿ÑƒÑÑ‚Ñ‹Ðµ
          if [ -z "$REGISTRY_URL" ]; then
            echo "âŒ Error: DOCKER_REGISTRY_URL is empty or not set"
            exit 1
          fi
          
          if [ -z "$IMAGE_NAME" ]; then
            echo "âŒ Error: DOCKER_IMAGE_NAME is empty or not set"
            exit 1
          fi
          
          echo "âœ… Registry URL: $REGISTRY_URL"
          echo "âœ… Image Name: $IMAGE_NAME"
        env:
          DOCKER_REGISTRY_URL: ${{ secrets.DOCKER_REGISTRY_URL }}
          DOCKER_IMAGE_NAME: ${{ secrets.DOCKER_IMAGE_NAME }}

      - name: Configure Docker for insecure registry (if needed)
        run: |
          if [ "$DOCKER_REGISTRY_INSECURE" != "true" ]; then
            echo "â„¹ï¸ DOCKER_REGISTRY_INSECURE not set to 'true', skipping insecure registry configuration"
            exit 0
          fi
          
          echo "âš ï¸ Configuring Docker for insecure registry..."
          REGISTRY_URL="${{ steps.validate.outputs.registry_url }}"
          
          # ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ insecure registry Ð² Docker daemon
          sudo mkdir -p /etc/docker
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚ Ð»Ð¸ ÑƒÐ¶Ðµ daemon.json
          if [ -f /etc/docker/daemon.json ]; then
            echo "ðŸ“‹ Existing daemon.json found, backing up..."
            sudo cp /etc/docker/daemon.json /etc/docker/daemon.json.bak
            # ÐžÐ±ÑŠÐµÐ´Ð¸Ð½ÑÐµÐ¼ Ñ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ð¼ ÐºÐ¾Ð½Ñ„Ð¸Ð³Ð¾Ð¼ (Ð¿Ñ€Ð¾ÑÑ‚Ð°Ñ Ð²ÐµÑ€ÑÐ¸Ñ)
            echo "{\"insecure-registries\": [\"$REGISTRY_URL\"]}" | sudo tee /etc/docker/daemon.json
          else
            echo "{\"insecure-registries\": [\"$REGISTRY_URL\"]}" | sudo tee /etc/docker/daemon.json
          fi
          
          # ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Docker daemon
          echo "ðŸ”„ Restarting Docker daemon..."
          if command -v systemctl &> /dev/null; then
            sudo systemctl restart docker || true
          elif command -v service &> /dev/null; then
            sudo service docker restart || true
          else
            # Ð’ GitHub Actions runner Docker Ð¼Ð¾Ð¶ÐµÑ‚ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÑÑ‚ÑŒÑÑ Ð¿Ð¾-Ð´Ñ€ÑƒÐ³Ð¾Ð¼Ñƒ
            echo "âš ï¸ Could not restart Docker daemon automatically"
            echo "âš ï¸ Please ensure Docker daemon is restarted manually if needed"
          fi
          
          # Ð”Ð°ÐµÐ¼ Ð²Ñ€ÐµÐ¼Ñ Ð½Ð° Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº Ð¸ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ Docker Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚
          sleep 5
          docker info > /dev/null 2>&1 || {
            echo "âš ï¸ Docker may not have restarted properly, but continuing..."
          }
          
          echo "âœ… Insecure registry configured: $REGISTRY_URL"

      - name: Log in to Docker Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ steps.validate.outputs.registry_url }}
          username: ${{ secrets.DOCKER_REGISTRY_USERNAME }}
          password: ${{ secrets.DOCKER_REGISTRY_PASSWORD }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ steps.validate.outputs.registry_url }}/${{ steps.validate.outputs.image_name }}
          tags: |
            type=ref,event=branch
            type=sha,prefix=sha-,format=short

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }},${{ steps.validate.outputs.registry_url }}/${{ steps.validate.outputs.image_name }}:latest
          cache-from: type=registry,ref=${{ steps.validate.outputs.registry_url }}/${{ steps.validate.outputs.image_name }}:buildcache
          cache-to: type=registry,ref=${{ steps.validate.outputs.registry_url }}/${{ steps.validate.outputs.image_name }}:buildcache,mode=max
      
      - name: Set job outputs
        id: job_outputs
        run: |
          echo "registry_url=${{ steps.validate.outputs.registry_url }}" >> $GITHUB_OUTPUT
          echo "image_name=${{ steps.validate.outputs.image_name }}" >> $GITHUB_OUTPUT

    outputs:
      registry_url: ${{ steps.job_outputs.outputs.registry_url }}
      image_name: ${{ steps.job_outputs.outputs.image_name }}

  deploy:
    name: Deploy to Server
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    env:
      DOCKER_REGISTRY_INSECURE: ${{ secrets.DOCKER_REGISTRY_INSECURE }}
      DEPLOY_SSH_PORT: ${{ secrets.DEPLOY_SSH_PORT }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_SSH_KEY }}

      - name: Validate SSH connection
        run: |
          SSH_PORT="${DEPLOY_SSH_PORT:-22}"
          ssh -o StrictHostKeyChecking=no -p "$SSH_PORT" ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} \
            "echo 'SSH connection successful' && hostname"

      - name: Deploy to server
        run: |
          SSH_PORT="${DEPLOY_SSH_PORT:-22}"
          DOCKER_REGISTRY_INSECURE_VALUE="${DOCKER_REGISTRY_INSECURE:-false}"
          ssh -o StrictHostKeyChecking=no -p "$SSH_PORT" ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} << 'REMOTE_SCRIPT'
            set -e
            
            # ÐŸÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
            export DOCKER_REGISTRY="$DOCKER_REGISTRY_VALUE"
            export DOCKER_IMAGE_NAME="$DOCKER_IMAGE_NAME_VALUE"
            export DOCKER_REGISTRY_USERNAME="$DOCKER_REGISTRY_USERNAME_VALUE"
            export DOCKER_REGISTRY_PASSWORD="$DOCKER_REGISTRY_PASSWORD_VALUE"
            export DOCKER_REGISTRY_INSECURE="$DOCKER_REGISTRY_INSECURE_VALUE"
            export PROJECT_DIR="$PROJECT_DIR_VALUE"
            
            # ÐŸÐµÑ€ÐµÑ…Ð¾Ð´Ð¸Ð¼ Ð² Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
            cd "$PROJECT_DIR" || exit 1
            
            # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð´ÐµÐ¿Ð»Ð¾Ñ
            bash scripts/deploy.sh
          REMOTE_SCRIPT
        env:
          DOCKER_REGISTRY_INSECURE_VALUE: ${{ env.DOCKER_REGISTRY_INSECURE }}
          DOCKER_REGISTRY_VALUE: ${{ needs.build-and-push.outputs.registry_url }}
          DOCKER_IMAGE_NAME_VALUE: ${{ needs.build-and-push.outputs.image_name }}
          DOCKER_REGISTRY_USERNAME_VALUE: ${{ secrets.DOCKER_REGISTRY_USERNAME }}
          DOCKER_REGISTRY_PASSWORD_VALUE: ${{ secrets.DOCKER_REGISTRY_PASSWORD }}
          PROJECT_DIR_VALUE: ${{ secrets.DEPLOY_PROJECT_PATH }}

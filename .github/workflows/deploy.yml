name: Build and Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  NODE_VERSION: '20'

jobs:
  validate:
    name: Validate Environment Variables
    runs-on: ubuntu-latest
    outputs:
      registry_url: ${{ steps.validate.outputs.registry_url }}
      image_name: ${{ steps.validate.outputs.image_name }}
    steps:
      - name: Validate and sanitize environment variables
        id: validate
        run: |
          # –ü–æ–ª—É—á–∞–µ–º –∏ –æ—á–∏—â–∞–µ–º DOCKER_REGISTRY_URL
          REGISTRY_URL="${DOCKER_REGISTRY_URL}"
          REGISTRY_URL=$(echo "$REGISTRY_URL" | sed 's|^https\?://||' | sed 's|/$||')
          
          # –ü–æ–ª—É—á–∞–µ–º –∏ –æ—á–∏—â–∞–µ–º DOCKER_IMAGE_NAME
          IMAGE_NAME="${DOCKER_IMAGE_NAME}"
          # –£–±–∏—Ä–∞–µ–º –≤—Å–µ —Å–∏–º–≤–æ–ª—ã, –∫—Ä–æ–º–µ —Å—Ç—Ä–æ—á–Ω—ã—Ö –±—É–∫–≤, —Ü–∏—Ñ—Ä, –¥–µ—Ñ–∏—Å–æ–≤, –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–π –∏ —Ç–æ—á–µ–∫
          IMAGE_NAME=$(echo "$IMAGE_NAME" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9._-]//g')
          
          echo "registry_url=$REGISTRY_URL" >> $GITHUB_OUTPUT
          echo "image_name=$IMAGE_NAME" >> $GITHUB_OUTPUT
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏—è –Ω–µ –ø—É—Å—Ç—ã–µ
          if [ -z "$REGISTRY_URL" ]; then
            echo "‚ùå Error: DOCKER_REGISTRY_URL is empty or not set"
            exit 1
          fi
          
          if [ -z "$IMAGE_NAME" ]; then
            echo "‚ùå Error: DOCKER_IMAGE_NAME is empty or not set"
            exit 1
          fi
          
          echo "‚úÖ Registry URL: $REGISTRY_URL"
          echo "‚úÖ Image Name: $IMAGE_NAME"
        env:
          DOCKER_REGISTRY_URL: ${{ secrets.DOCKER_REGISTRY_URL }}
          DOCKER_IMAGE_NAME: ${{ secrets.DOCKER_IMAGE_NAME }}

  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: validate
    env:
      DOCKER_REGISTRY_INSECURE: ${{ secrets.DOCKER_REGISTRY_INSECURE }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install jq (for daemon.json manipulation)
        if: env.DOCKER_REGISTRY_INSECURE == 'true'
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y jq

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Configure Docker for insecure registry (if needed)
        if: env.DOCKER_REGISTRY_INSECURE == 'true'
        run: |
          echo "‚ö†Ô∏è Configuring Docker for insecure registry (TLS verification disabled)..."
          REGISTRY_URL="${{ needs.validate.outputs.registry_url }}"
          
          # –í GitHub Actions runner'–∞—Ö –ù–ï –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º Docker daemon, —Ç.–∫. —ç—Ç–æ –ª–æ–º–∞–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
          # –í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Buildx
          
          # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º insecure registry –≤ Docker daemon (–¥–ª—è —Å–ø—Ä–∞–≤–∫–∏, –Ω–æ –±–µ–∑ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞)
          sudo mkdir -p /etc/docker
          
          # –ß–∏—Ç–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π daemon.json –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π
          if [ -f /etc/docker/daemon.json ]; then
            echo "üìã Existing daemon.json found, backing up..."
            sudo cp /etc/docker/daemon.json /etc/docker/daemon.json.bak
            
            # –ü—ã—Ç–∞–µ–º—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å jq –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è insecure-registries
            if command -v jq &> /dev/null; then
              echo "Using jq to merge insecure-registries..."
              sudo cat /etc/docker/daemon.json | jq --arg reg "$REGISTRY_URL" \
                '.insecure-registries = (if .insecure-registries then (. + [$reg] | unique) else [$reg] end)' | \
                sudo tee /etc/docker/daemon.json > /dev/null
            else
              # Fallback: –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º (–º–æ–∂–µ—Ç –ø–æ—Ç–µ—Ä—è—Ç—å –¥—Ä—É–≥–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏)
              echo "‚ö†Ô∏è jq not available, overwriting daemon.json"
              echo "{\"insecure-registries\": [\"$REGISTRY_URL\"]}" | sudo tee /etc/docker/daemon.json
            fi
          else
            echo "Creating new daemon.json..."
            echo "{\"insecure-registries\": [\"$REGISTRY_URL\"]}" | sudo tee /etc/docker/daemon.json
          fi
          
          # –û—Ç–∫–ª—é—á–∞–µ–º TLS –¥–ª—è Docker –∫–ª–∏–µ–Ω—Ç–∞ (–¥–ª—è Buildx –∏ –¥—Ä—É–≥–∏—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤)
          # –≠—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ daemon
          echo "DOCKER_TLS_CERTDIR=" >> $GITHUB_ENV
          
          echo "‚ÑπÔ∏è Docker daemon configuration updated (daemon.json)"
          echo "‚ÑπÔ∏è Note: In GitHub Actions managed runners, daemon restart is not needed"
          echo "‚ÑπÔ∏è Insecure registry will be used via DOCKER_TLS_CERTDIR and Buildx settings"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ Docker –≤—Å–µ –µ—â–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
          if docker info > /dev/null 2>&1; then
            echo "‚úÖ Docker is running"
          else
            echo "‚ùå ERROR: Docker is not accessible after configuration"
            echo "This should not happen - Docker daemon was not restarted"
            exit 1
          fi
          
          echo "‚úÖ Insecure registry configured: $REGISTRY_URL"

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ needs.validate.outputs.registry_url }}/${{ needs.validate.outputs.image_name }}
          tags: |
            type=ref,event=branch
            type=sha,prefix=sha-,format=short

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: false
          load: true
          tags: ${{ steps.meta.outputs.tags }},${{ needs.validate.outputs.registry_url }}/${{ needs.validate.outputs.image_name }}:latest
          cache-from: type=registry,ref=${{ needs.validate.outputs.registry_url }}/${{ needs.validate.outputs.image_name }}:buildcache
          cache-to: type=registry,ref=${{ needs.validate.outputs.registry_url }}/${{ needs.validate.outputs.image_name }}:buildcache,mode=max
        env:
          DOCKER_TLS_CERTDIR: ${{ env.DOCKER_TLS_CERTDIR || '' }}

  push:
    name: Push Docker Image
    runs-on: ubuntu-latest
    needs: [validate, build]
    env:
      DOCKER_REGISTRY_INSECURE: ${{ secrets.DOCKER_REGISTRY_INSECURE }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install jq (for daemon.json manipulation)
        if: env.DOCKER_REGISTRY_INSECURE == 'true'
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y jq

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Configure Docker for insecure registry (if needed)
        if: env.DOCKER_REGISTRY_INSECURE == 'true'
        run: |
          echo "‚ö†Ô∏è Configuring Docker for insecure registry (TLS verification disabled)..."
          REGISTRY_URL="${{ needs.validate.outputs.registry_url }}"
          
          # –í GitHub Actions runner'–∞—Ö –ù–ï –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º Docker daemon, —Ç.–∫. —ç—Ç–æ –ª–æ–º–∞–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
          # –í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Buildx
          
          # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º insecure registry –≤ Docker daemon (–¥–ª—è —Å–ø—Ä–∞–≤–∫–∏, –Ω–æ –±–µ–∑ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞)
          sudo mkdir -p /etc/docker
          
          # –ß–∏—Ç–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π daemon.json –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π
          if [ -f /etc/docker/daemon.json ]; then
            echo "üìã Existing daemon.json found, backing up..."
            sudo cp /etc/docker/daemon.json /etc/docker/daemon.json.bak
            
            # –ü—ã—Ç–∞–µ–º—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å jq –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è insecure-registries
            if command -v jq &> /dev/null; then
              echo "Using jq to merge insecure-registries..."
              sudo cat /etc/docker/daemon.json | jq --arg reg "$REGISTRY_URL" \
                '.insecure-registries = (if .insecure-registries then (. + [$reg] | unique) else [$reg] end)' | \
                sudo tee /etc/docker/daemon.json > /dev/null
            else
              # Fallback: –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º (–º–æ–∂–µ—Ç –ø–æ—Ç–µ—Ä—è—Ç—å –¥—Ä—É–≥–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏)
              echo "‚ö†Ô∏è jq not available, overwriting daemon.json"
              echo "{\"insecure-registries\": [\"$REGISTRY_URL\"]}" | sudo tee /etc/docker/daemon.json
            fi
          else
            echo "Creating new daemon.json..."
            echo "{\"insecure-registries\": [\"$REGISTRY_URL\"]}" | sudo tee /etc/docker/daemon.json
          fi
          
          # –û—Ç–∫–ª—é—á–∞–µ–º TLS –¥–ª—è Docker –∫–ª–∏–µ–Ω—Ç–∞ (–¥–ª—è Buildx –∏ –¥—Ä—É–≥–∏—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤)
          # –≠—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ daemon
          echo "DOCKER_TLS_CERTDIR=" >> $GITHUB_ENV
          
          echo "‚ÑπÔ∏è Docker daemon configuration updated (daemon.json)"
          echo "‚ÑπÔ∏è Note: In GitHub Actions managed runners, daemon restart is not needed"
          echo "‚ÑπÔ∏è Insecure registry will be used via DOCKER_TLS_CERTDIR and Buildx settings"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ Docker –≤—Å–µ –µ—â–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
          if docker info > /dev/null 2>&1; then
            echo "‚úÖ Docker is running"
          else
            echo "‚ùå ERROR: Docker is not accessible after configuration"
            echo "This should not happen - Docker daemon was not restarted"
            exit 1
          fi
          
          echo "‚úÖ Insecure registry configured: $REGISTRY_URL"

      - name: Log in to Docker Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ needs.validate.outputs.registry_url }}
          username: ${{ secrets.DOCKER_REGISTRY_USERNAME }}
          password: ${{ secrets.DOCKER_REGISTRY_PASSWORD }}
        env:
          DOCKER_TLS_CERTDIR: ${{ env.DOCKER_TLS_CERTDIR || '' }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ needs.validate.outputs.registry_url }}/${{ needs.validate.outputs.image_name }}
          tags: |
            type=ref,event=branch
            type=sha,prefix=sha-,format=short

      - name: Push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }},${{ needs.validate.outputs.registry_url }}/${{ needs.validate.outputs.image_name }}:latest
          cache-from: type=registry,ref=${{ needs.validate.outputs.registry_url }}/${{ needs.validate.outputs.image_name }}:buildcache
        env:
          DOCKER_TLS_CERTDIR: ${{ env.DOCKER_TLS_CERTDIR || '' }}

    outputs:
      registry_url: ${{ needs.validate.outputs.registry_url }}
      image_name: ${{ needs.validate.outputs.image_name }}

  deploy:
    name: Deploy to Server
    needs: push
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    env:
      DOCKER_REGISTRY_INSECURE: ${{ secrets.DOCKER_REGISTRY_INSECURE }}
      DEPLOY_SSH_PORT: ${{ secrets.DEPLOY_SSH_PORT }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_SSH_KEY }}

      - name: Validate SSH connection
        run: |
          SSH_PORT="${DEPLOY_SSH_PORT:-22}"
          ssh -o StrictHostKeyChecking=no -p "$SSH_PORT" ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} \
            "echo 'SSH connection successful' && hostname"

      - name: Deploy to server
        run: |
          SSH_PORT="${DEPLOY_SSH_PORT:-22}"
          DOCKER_REGISTRY_INSECURE_VALUE="${DOCKER_REGISTRY_INSECURE:-false}"
          ssh -o StrictHostKeyChecking=no -p "$SSH_PORT" ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} << 'REMOTE_SCRIPT'
            set -e
            
            # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
            export DOCKER_REGISTRY="$DOCKER_REGISTRY_VALUE"
            export DOCKER_IMAGE_NAME="$DOCKER_IMAGE_NAME_VALUE"
            export DOCKER_REGISTRY_USERNAME="$DOCKER_REGISTRY_USERNAME_VALUE"
            export DOCKER_REGISTRY_PASSWORD="$DOCKER_REGISTRY_PASSWORD_VALUE"
            export DOCKER_REGISTRY_INSECURE="$DOCKER_REGISTRY_INSECURE_VALUE"
            export PROJECT_DIR="$PROJECT_DIR_VALUE"
            
            # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
            cd "$PROJECT_DIR" || exit 1
            
            # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∫—Ä–∏–ø—Ç –¥–µ–ø–ª–æ—è
            bash scripts/deploy.sh
          REMOTE_SCRIPT
        env:
          DOCKER_REGISTRY_INSECURE_VALUE: ${{ env.DOCKER_REGISTRY_INSECURE }}
          DOCKER_REGISTRY_VALUE: ${{ needs.push.outputs.registry_url }}
          DOCKER_IMAGE_NAME_VALUE: ${{ needs.push.outputs.image_name }}
          DOCKER_REGISTRY_USERNAME_VALUE: ${{ secrets.DOCKER_REGISTRY_USERNAME }}
          DOCKER_REGISTRY_PASSWORD_VALUE: ${{ secrets.DOCKER_REGISTRY_PASSWORD }}
          PROJECT_DIR_VALUE: ${{ secrets.DEPLOY_PROJECT_PATH }}
